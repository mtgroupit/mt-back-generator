package api

import (
	"fmt"
	"net/http"
	"testing"

	"{{.Module}}/internal/api/restapi/models"
	"{{.Module}}/internal/app"
	"{{.Module}}/internal/def"
	extauthapi "{{.AuthSrv}}"

	{{- $strfmtOn := false}}
	{{- if .HaveDateTime}}
		"github.com/go-openapi/strfmt"
		{{- $strfmtOn = true}}
	{{- end}}
	{{- if not $strfmtOn}}
		{{- range $modelName, $model := $.Models}}
			{{- if and (not $strfmtOn) ($model.HaveEmail)}}
				"github.com/go-openapi/strfmt"
				{{- $strfmtOn = true}}
			{{- end}}
		{{- end}}
	{{- end}}
	{{- if .HaveConv}}
		"github.com/go-openapi/strfmt/conv"
	{{- end}}
	{{- if .HaveSwag}}
		"github.com/go-openapi/swag"
	{{- end}}
	"github.com/golang/mock/gomock"
	"github.com/powerman/check"
	"github.com/powerman/gotest/testinit"
	"github.com/google/uuid"
	"github.com/phayes/freeport"
)

var (
	isolatedEntityID = uuid.New().String()
	profID           = uuid.New().String()
	sess             = extauthapi.SessionCookieName + "=sess"
	profile          = &extauthapi.Profile{
		ID:    extauthapi.MustParseID(profID),
		Authn: true,
	}

{{- range $modelName, $model := $.Models}}
	{{- $idType := (index $model.Columns "id").Type}}
	test{{$modelName}}ID1 {{if eq $idType "int64"}}int64{{end}} = {{if eq $idType "uuid"}}{{if $model.IDFromIsolatedEntity}}isolatedEntityID{{else}}uuid.New().String(){{end}}{{else}}1{{end}}
	test{{$modelName}}1 = &models.{{$modelName}}{  
		{{- range $column, $options := $model.Columns}}
		{{$options.TitleName}}: {{if eq $column "id"}}test{{$modelName}}ID1{{else}}{{if $options.IsStruct}}{{if $options.IsArray}}test{{$options.GoType}}s{{else}}test{{$options.GoType}}1{{end}}{{else}}{{GenApiTestValue $options}}{{end}}{{end}},
		{{- end}}
	}
	{{- if not $model.IDFromIsolatedEntity}}
		test{{$modelName}}ID2 {{if eq $idType "int64"}}int64{{end}} = {{if eq $idType "uuid"}}uuid.New().String(){{else}}2{{end}}
		test{{$modelName}}2 = &models.{{$modelName}}{  
			{{- range $column, $options := $model.Columns}}
			{{$options.TitleName}}: {{if eq $column "id"}}test{{$modelName}}ID1{{else}}{{if $options.IsStruct}}{{if $options.IsArray}}test{{$options.GoType}}s{{else}}test{{$options.GoType}}2{{end}}{{else}}{{GenApiTestValue $options}}{{end}}{{end}},
			{{- end}}
		}
		test{{$modelName}}s = []*models.{{$modelName}}{test{{$modelName}}1, test{{$modelName}}2}
	{{- end}}
	testAdd{{$modelName}}1 = &models.{{$modelName}}Add{  
		{{- range $column, $options := $model.Columns}}
		{{- if and (ne $column "id") (not (IsStandardColumn $column))}}
		{{$options.TitleName}}: {{if $options.IsStruct}}{{if $options.IsArray}}[]{{if eq $idType "uuid"}}string{{else}}int64{{end}}{test{{$options.GoType}}ID1, test{{$options.GoType}}ID2}{{else}}test{{$options.GoType}}1.ID{{end}}{{else}}{{GenApiTestValue $options}}{{end}},
		{{- end}}
		{{- end}}
	}
	{{- if not $model.IDFromIsolatedEntity}}
	testAdd{{$modelName}}2 = &models.{{$modelName}}Add{  
		{{- range $column, $options := $model.Columns}}
		{{- if and (ne $column "id") (not (IsStandardColumn $column))}}
		{{$options.TitleName}}: {{if $options.IsStruct}}{{if $options.IsArray}}[]{{if eq $idType "uuid"}}string{{else}}int64{{end}}{test{{$options.GoType}}ID1, test{{$options.GoType}}ID2}{{else}}test{{$options.GoType}}2.ID{{end}}{{else}}{{GenApiTestValue $options}}{{end}},
		{{- end}}
		{{- end}}
	}
	{{- end}}
{{- end}}
	{{if .HaveListMethod}}
	offset int64 = 0
	limit  int64 = 5

	testFilters = []*models.FilterParams{
		&models.FilterParams{
			Key:     "ID",
			Include: true,
			Value:   "1",
		},
		&models.FilterParams{
			Key:     "ID",
			Include: false,
			Value:   "2",
		},
	}
	testList = &models.ListParams{
		Offset: offset,
		Limit:  &limit,
		LogicFilter: false,
		SortBy: "ASC",
	}
	{{end}}
)

func TestMain(m *testing.M) { testinit.Main(m) }

func testNewServer(t *check.C) (string, func(), *app.MockApp, *MockAuthSvc) {
	t.Helper()
	ctrl := gomock.NewController(t)

	mockApp := app.NewMockApp(ctrl)
	mockExtAuthSvc := NewMockAuthSvc(ctrl)

	port , err := freeport.GetFreePort()
	if err != nil {
		log.Fatal(err)
	}
	
	server, err := NewServer(mockApp, mockExtAuthSvc, Config{
		Host:     "localhost",
		Port:     port,
		BasePath: def.APIBasePath,
	})
	t.Nil(err, "NewServer")
	t.Nil(server.Listen(), "server.Listen")
	errc := make(chan error, 1)
	go func() { errc <- server.Serve() }()

	shutdown := func() {
		t.Helper()
		t.Nil(server.Shutdown(), "server.Shutdown")
		t.Nil(<-errc, "server.Serve")
		ctrl.Finish()
	}

	url := fmt.Sprintf("localhost:%d", server.Port)

	return url, shutdown, mockApp, mockExtAuthSvc
}

type matchCookie string // Implements gomock.Matcher.

func (m matchCookie) String() string { return string(m) }
func (m matchCookie) Matches(x interface{}) bool {
	for _, c := range (&http.Request{Header: map[string][]string{"Cookie": {x.(string)}}}).Cookies() {
		if c.String() == string(m) {
			return true
		}
	}
	return false
}
